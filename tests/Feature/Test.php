<?php

declare(strict_types=1);

use Google\Protobuf\PrintOptions;
use Tests\GoogleProto\DataTypes as GoogleProtoDataTypes;
use Tests\Proto\DataTypes;

test('test', function () {
    $testSkip = [
        10,
        4,
        116,
        101,
        115,
        116,
        16,
        251,
        255,
        198,
        53,
        24,
        1,
        37,
        121,
        147,
        129,
        63,
        41,
        60,
        222,
        100,
        224,
        222,
        123,
        103,
        65,
        50,
        11,
        95,
        116,
        101,
        115,
        116,
        95,
        98,
        121,
        116,
        101,
        115,
        58,
        12,
        10,
        4,
        116,
        101,
        115,
        116,
        18,
        4,
        116,
        101,
        115,
        116,
        58,
        14,
        10,
        5,
        104,
        101,
        108,
        108,
        111,
        18,
        5,
        119,
        111,
        114,
        108,
        100,
        66,
        3,
        10,
        20,
        30,
        72,
        185,
        96,
        82,
        14,
        116,
        101,
        115,
        116,
        95,
        110,
        101,
        119,
        95,
        102,
        105,
        101,
        108,
        100,
    ];

    $bin = $testSkip;

    gc_collect_cycles();
    $start = hrtime(true);
    $count = 10000;
    for ($i = 0; $i < $count; $i++) {
        $d = DataTypes::fromBytes($bin);
    }
    $end = ((hrtime(true) - $start) / 1000000) / $count;
    dump($end . ' ms');
    dump(json_encode($d));
});

test('test-google', function () {
    $testSkip = [
        10,
        4,
        116,
        101,
        115,
        116,
        16,
        251,
        255,
        198,
        53,
        24,
        1,
        37,
        121,
        147,
        129,
        63,
        41,
        60,
        222,
        100,
        224,
        222,
        123,
        103,
        65,
        50,
        11,
        95,
        116,
        101,
        115,
        116,
        95,
        98,
        121,
        116,
        101,
        115,
        58,
        12,
        10,
        4,
        116,
        101,
        115,
        116,
        18,
        4,
        116,
        101,
        115,
        116,
        58,
        14,
        10,
        5,
        104,
        101,
        108,
        108,
        111,
        18,
        5,
        119,
        111,
        114,
        108,
        100,
        66,
        3,
        10,
        20,
        30,
        72,
        185,
        96,
        82,
        14,
        116,
        101,
        115,
        116,
        95,
        110,
        101,
        119,
        95,
        102,
        105,
        101,
        108,
        100,
    ];

    $bin = $testSkip;

    gc_collect_cycles();
    $start = hrtime(true);
    $count = 10000;
    for ($i = 0; $i < $count; $i++) {
        $d = new GoogleProtoDataTypes();
        $d->mergeFromString(implode('', array_map('chr', $bin)));
    }
    $end = ((hrtime(true) - $start) / 1000000) / $count;
    dump($end . ' ms');
    dump($d->serializeToJsonString(PrintOptions::PRESERVE_PROTO_FIELD_NAMES));
});
